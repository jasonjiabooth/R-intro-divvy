---
title: "Introduction to R for data analysis"
author: Peter Carbonetto
output:
  beamer_presentation:
    template: docs/beamer.tex
    keep_tex: false
    fig_caption: false
    pandoc_args: "--highlight-style=pygments"
---

```{r knitr-options, echo=FALSE}
knitr::opts_chunk$set(results = "hide",fig.show = "hide",
                      message = FALSE,warning = FALSE)
```

2. Aims of workshop
===================

1. Get hands-on experience with the basic elements of data analysis
   in R.

2. Understand how to import data from a CSV file into an R data frame.

3. Use standard tools to summarize & manipulate data frames.

4. Learn how to install & use R packages.

5. Use ggplot2 to plot data.

6. Learn through "live coding".

# 3. Our goal: Analyze Divvy data from 2016 & 2017

+ Investigate bike sharing trends in Chicago.

+ We will use data made available by Divvy:

    - www.divvybikes.com/system-data

+ We will import and inspect the data, and take steps to prepare the
  data for analysis and plotting.

+ Once we have carefully prepared the data, creating visualizations is
  (relatively) little effort.

4. The programmatic approach
============================

+ Data analysis usually involves *iterative refinement* and *repetition*.

+ The *programmatic approach* to data analysis will allow you to...

    - Automate your analysis.

    - Quickly create a new analysis from existing code.

    - Expand capabilities with R packages.

5. It's your choice
===================

Your may choose to...

+ Use R on your computer.

+ Use RStudio on your computer.

+ Use RStudio Cloud.

+ Follow what I do on the projector.

6. Software we will use today
=============================

1. **R** and/or **RStudio**.

2. R packages **readr**, **ggplot2** & **cowplot**.

# 7. Outline of workshop

1. Initial setup.

2. Analysis of Divvy station data.

3. Analysis of Divvy trip data.

4. Combining the data.

# 8. Initial setup

+ Set up RStudio Cloud (optional).

+ Workshop packet.

+ Reading what I type.

+ Pace, questions (e.g., keyboard shortcuts).

+ Help.

9. Set up RStudio Cloud (optional)
=================================

+ Go to [**https://rstudio.cloud**][rstudio-cloud].

+ If necessary, log in or create an account.

+ In Your Workspace, select **New Project > New Project From Git Repo**.

+ Enter this URL: 

https://github.com/rcc-uchicago/R-intro-divvy

10. Download or "clone" git repository
======================================

*If not using RStudio Cloud,* download the workshop packet to your
computer.

+ Go to [**http://github.com/rcc-uchicago/R-intro-divvy**][github-repo]

+ To download, click the green **"Clone or download"** button.

Or, if you have **git**, run this command:

```{bash download-repo, eval=FALSE}
git clone https://github.com/rcc-uchicago/
  R-intro-divvy.git
```

(Note the URL in the git command should not contain any spaces.)

+ If necessary, uncompress the ZIP file.

+ If necessary, rename folder to **R-intro-divvy**.

11. What's included in the workshop packet
==========================================

+ **slides.pdf**: These slides.

+ **slides.Rmd**: R Markdown source used to generate these
  slides. *You may open this file in RStudio or your favourite
  editor.*

+ **read_trip_data.R**: Some R code used in the examples.

+ **Divvy_Stations_2017_Q3Q4.csv:** Divvy station data.

+ **Divvy_Trips_2019_Q4.csv.gz:** 2019 Divvy trip data.

12. Set up your R environment
=============================

+ Launch R or RStudio.

13. Load code for the hands-on exercises
========================================

Open R Markdown source file, **slides.Rmd**.

  + In RStudio, select **File > Open File**.

  + Alternatively, use your favourite text editor.

14. Run `sessionInfo()`
=======================

Check the version of R that you are using:

```{r check-version}
sessionInfo()
```

15. Clear your workspace
========================

The R environment is where all variables (and functions) are stored
and accessed. It is Best Practice to start with an empty environment,
or "workspace". Run this:

```{r check-env}
ls()
```

If this outputs names of objects, it means your environment is not
empty and you should restart R with a clean environment. Do either:

+ `rm(list = ls())`.

+ Or, in RStudio, **Session > Clear Workspace**.

> Instructor notes: This is a good opportunity to explain why it is
> important to start with a fresh environment when starting a new
> analysis.
>
> This is also a good opportunity to point out some of the RStudio
> options that should be turned off.

16. The Console is where the action is
======================================

![](docs/images/rstudio.jpg)

17. Set your working directory to "R-intro-divvy"
=================================================

Check that you have the right working directory:

```{r list-files}
list.files()
```

You should see the tutorial files. If you don't, change your working
directory:

  + In R, use the `setwd()` function.

  + In RStudio, select **Session > Set Working Directory > Choose
    Directory...`**

If you have changed your working directory, double-check that you have
the right working directory before continuing.

18. Outline of workshop
=======================

1. Initial setup.

2. **Analysis of Divvy station data.**

3. Analysis of Divvy trip data.

4. Combining the data.

# 19. View CSV file

Open the CSV file **Divvy_Stations_2017_Q3Q4.csv** in RStudio or your
favourite text editor (e.g., Notepad in Windows, TextEdit on Mac).

> Instructor notes:
> 
>   + CSV is a simple and commonly used data format.
>   + It is easily read into R, and read by humans.
>   + Each line stores an item (station).
>   + The first line is a special line called the "header".
>   + Entries in each line (table row) are separated by commas.
>

20. Import station data into R
==============================

Read the station data into a "data frame":

```{r read-station-data}
stations<-read.csv("Divvy_Stations_2017_Q3Q4.csv",
                   stringsAsFactors = FALSE)
```

This will create a new object, "stations", in your environment:

```{r inspect-station-data-1}
ls()
```

It is a "data frame" object:

```{r inspect-station-data-2}
class(stations)
```

> Instructor notes: What does "read.csv" do, and what is a "data
> frame"? R has detailed documentation on these these topics:
> 
> ```{r help-readcsv-dataframe, eval=FALSE}
> help(read.csv)
> help(data.frame)
> ```

21. Inspect the station data
============================

Check that the data were read correctly, and inspect the table:

```{r inspect-station-data-3}
nrow(stations)
ncol(stations)
head(stations)
tail(stations)
summary(stations)
str(stations)
```

Inspect the data further:

```{r inspect-station-data-4}
sapply(stations,class)
object.size(stations)
```

> Instructor notes: Let the students first run these commands, and
> let them figure out what sort of data is contained in this table.
> Does this reveal any issues with the data?
>
> Some of these commands, like "head", "str" and "summary", are
> “generic” functions, meaning that they work for a wide variety of
> object types, not just data frames.

22. Take a closer look at the "dpcapacity" column
=================================================

Make a copy of the "dpcapacity" column:

```{r inspect-dpcapacity-data-1}
x <- stations$dpcapacity
```

Run a few commands to take a closer look at the "dpcapacity" column:

```{r inspect-dpcapacity-data-2}
class(x)
length(x)
summary(x)
min(x)
max(x)
mean(x)
median(x)
quantile(x,0.5)
table(x)
```

> Instructor notes: What do the results of running these commands tell
> us about "dpcapacity"?

23. Data subviews
=================

When you are working with large data sets, you need a strategy to
inspect manageable subsets of the data. Here are some examples of
printing subsets of the data:

```{r head-tail}
head(stations,n = 4)
tail(stations,n = 4)
```

More examples:

```{r select-rows}
stations[1:4,]
stations$name[1:4]
stations[1:4,2]
stations[1:4,"name"]
```

24. Data subviews
=================

Yet more examples:

```{r select-columns}
stations[1:4,c(2,3,6)]
stations[1:4,c("name","city","dpcapacity")]
```

> Instructor notes: Once you are comfortable with the basic elements
> of selecting subsets, you can combine these elements in an endless
> variety of ways.

25. Conditional subviews
========================

One powerful way to inspect subsets is by condition. For example, to
view all the stations with more than 40 docks, do

```{r subset-1}
subset(stations,dpcapacity > 40)
```

or, equivalently,

```{r subset-2}
stations[stations$dpcapacity > 40,]
```

It is interesting that a couple of the Divvy bike stations have no
docks. What are these stations?

```{r subset-3}
# Add code here.
```

> Answer: subset(stations,dpcapacity == 0)

26. Conditional subviews
========================

Once you have generated a subview that you want to explore further,
you can create a new data set from a subview, e.g.,

```{r subset-4}
largest_stations<-subset(stations,dpcapacity > 40)
```

This object is also a data frame:

```{r subset-5}
class(largest_stations)
```

> Instructor notes: It isn’t unusual to have half a dozen different
> copies of a data set over the course of an analysis. This is where
> it is important to keep track of what you are doing, and name things
> well! This is where the `rm` function also comes in handy for cleaning
> up your workspace.

27. Ordering the stations by number of docks
============================================

Here's way to access data on the smallest and largest stations:

```{r inspect-dpcapacity-data-5}
rows <- order(stations$dpcapacity)
stations2 <- stations[rows,]
head(stations2)
tail(stations2)
```

28. Take a closer look at the "city" column
===========================================

Above, we examined numeric data. Now let's take a close look at
another type of data.

```{r inspect-city-data-1}
x <- stations$city
class(x)
summary(x)
```

The summary is not very useful here! The key is to convert to a
"factor":

```{r inspect-city-data-2}
x <- factor(stations$city)
class(x)
summary(x)
```

> Instructor notes: What issue with the data did we uncover from
> running these commands?
>
> What is a factor?

29. Fixing the "city" column
============================

Let's fix the problem of two "Chicago" categories. First, select the
offending rows in the table:

```{r revise-city-data-1}
rows <- which(stations$city == "Chicago ")
```

Fix the "city" column by *overwriting* the selected rows:

```{r revise-city-data-2}
stations[rows,"city"] <- "Chicago"
x <- factor(stations$city)
summary(x)
```

The "city" column is more useful if it is a factor, so let's modify
this column *inside* the data frame:

```{r revise-city-data-3}
stations$city <- factor(stations$city)
summary(stations$city)
```

30. Create a map of the Divvy stations
======================================

A scatterplot can be created from two numeric vectors very simply
using the "plot" function. Let's see what happens if we plot the
geographic co-ordinates (latitude & longitude) of the stations.

```{r plot-stations-1}
plot(stations$longitude,stations$latitude,
     pch = 20)
```

The plot function has many, many options. We will not explore these
options here. Let's add color to the plot according to the "city"
column:

```{r plot-stations-2}
plot(stations$longitude,stations$latitude,
     col = stations$city,pch = 20)
```

> Instructor notes: What geographic features of Chicago are
> recognizable from this plot?

31. Create stations map using ggplot2
=====================================

Now let's recreate the stations map using **ggplot2**. It is a
powerful (though not immediately intuitive) plotting interface. First,
install ggplot2 if you have not already done so. (We will also use
cowplot, an extension to ggplot2.)

```{r install-ggplot2, eval=FALSE}
install.packages("ggplot2")
install.packages("cowplot")
```

As you can see, the ggplot2 code is a bit more complicated:

```{r plot-stations-3}
library(ggplot2)
p1 <- ggplot(stations,
             aes(x = longitude,
			     y = latitude,
				 color = city)) +
  geom_point()
print(p1)
```

What is better about the new plot? 

32. More on ggplot2
===================

+ All plots in ggplot2 require these three elements:

    1. A data frame.

    2. An "aesthetic mapping" that maps columns to plot features
       (axes, shapes, colors, *etc.*).

    3. A "geom", short for “geometric object,” that specifies the type
        of plot.

+ All plots are created by *adding layers.*

+ ggplot2 has an excellent website where you can learn more:
  [ggplot2.tidyverse.org][ggplot2]

33. A better stations map
=========================

Not satisfied with this plot, I experimented with the `geom_point`
settings to improve the plot a bit:

```{r plot-stations-4}
p2 <- ggplot(stations,
             aes(x = longitude,
			     y = latitude,
				 fill = city)) +
  geom_point(shape = 21,size = 2,color = "white")
print(p2)
```

34. A better stations map
=========================

The default colours in ggplot2 are not great; they can be overrided
here with the "scale" function `scale_fill_manual`. Also, I'm a big
fan of the cowplot theme:

```{r plot-stations-5}
library(cowplot)
p2 <- p2 +
  scale_fill_manual(values = c("dodgerblue",
                               "darkorange",
							   "darkblue")) +
  theme_cowplot(font_size = 10)
print(p2)
```

We have only touched the surface of what ggplot2 can do. Observe that
adjustments to the plot are made by adding "layers". This is one of
the distinctive features of ggplot2.

35. Save & share your plot
==========================

Let's save this last plot as a file that can be shared with others.

```{r save-station-map}
ggsave("stations.png",p2,dpi = 200)
ggsave("stations.pdf",p2)
```

> Instructor notes: How do the PDF and PNG formats differ? When should
> you save the plot as a PDF, and when should you save as a PNG?

36. Save your results
=====================

It is important to periodically save your code and results. (Remember
there is no "undo" command in R!) To save your workspace, go to
**Session > Save Workspace As...** in RStudio, or run this code:

```{r save-session-1}
save.image("divvy_analysis.RData")
```

Later, to restore your environment in a new session, select **Session >
Load Workspace...** in RStudio, or run this code:

```{r load-session, eval=FALSE}
load("divvy_analysis.RData")
```

37. Main concepts covered so far
================================

+ The R workspace & working directory.

+ Read a data frame from a text (CSV) file.

+ Tools to inspect a data frame.

+ Tools to manipulate a data frame.

+ Subviews and conditional subviews.

+ Ordering rows of a data frame.

+ Factors.

+ Creating a plot using "plot".

+ Creating a plot using ggplot2.

+ Saving your results.

38. Outline of workshop
=======================

1. Initial setup.

2. Analysis of Divvy station data.

3. **Analysis of Divvy trip data.**

4. Combining the data.

# 39. Automating the data preparation

Preparing a data set for analysis can be tedious. I've simplified the
preparation of the Divvy trip data for you by writing a *script* to do
this.

# 38. Import the Divvy trip data into R

Previously, we used `read.csv` to import station data into R. Let's
now use `read.csv` to load the trip data from the 4th quarter of 2017:

```{r read-trip-data}
trips <-
  read.csv("Divvy_Trips_2017_Q4.csv",
           stringsAsFactors = FALSE)
```

You may find that this command look longer to run than before. The
trips data frame is much larger:

```{r trip-data-size}
nrow(trips)
ncol(trips)
object.size(trips)
```

> Instructor notes: This gives an opportunity to demonstrate a faster
> method implemented in a package.

34. Import Divvy trip data using `readr` (optional)
===================================================

Install the **readr** package from CRAN:

```{r install-readr, eval=FALSE}
install.packages("readr")
```

Load the package functions into your R environment:

```{r load-readr}
library(readr)
```

Let's use the `read_csv` function from this package:

```{r read-trip-data-readr}
trips <- read_csv("Divvy_Trips_2017_Q4.csv")
```

> Instructor notes: How much faster is `read_csv`? `read_csv` is
> similar to `read.csv`, but not the same.

35. Import Divvy trip data using `readr` (optional)
===================================================

The `read_csv` output is *not* a data frame—it is a "tibble".

```{r check-trip-data-class}
class(trips)
```

Usually, I convert it to a data frame:

```{r convert-trip-data}
class(trips) <- "data.frame"
```

> Instructor notes:
>
>   + Explain that modifying the class of an object should only be
>     done very rarely, and only when you know what you are doing!
>     Here we know that "trips" is already a data frame (and also a
>     tibble).
>
>   + The readr package has many other features not covered here.
>
>   + Another fast method is `fread` from the "data.table" package.
>
>   + "Vignettes" are a great way to learn about a package:
>      `vignette("readr")
>
>   + How to learn more about a package? `help(package = readr)`
>
>   + Where are the packages installed to? `.libPaths()`
>

36. A first glance at the trips data
====================================

Let's use some of the same commands we used earlier to quickly get an
overview of the trip data:

```{r inspect-trip-data}
nrow(trips)
ncol(trips)
head(trips)
summary(trips)
```

> Instructor notes: Unfortunately, the summary command isn't
> particularly informative for many of the columns. What columns should
> we convert to factors?

37. Convert "gender" to a factor
================================

Let's begin by converting the "gender" column to a factor:

```{r convert-trip-data-1}
trips$gender <- factor(trips$gender)
summary(trips$gender)
levels(trips$gender)
```

> Instructor notes: We see that many gender entries are missing.

38. Missing data
================

+ In R, "missing data" should be assigned the special value `NA` ("not
  available").

+ Many functions in R will correctly handle missing data as long as
  they are encoded as `NA`.

+ The `read_csv` function from the `readr` package was "smart" enough
  to figure out that blank entries in the CSV file should be converted
  to `NA`.

39. Convert "station" columns to factors
========================================

Likewise, the "from station" column is also more useful as a factor:

```{r summarize-from-station-data}
summary(trips$from_station_name)
trips$from_station_name <-
  factor(trips$from_station_name)
summary(trips$from_station_name)
```

> Instructor notes: What do these numbers give us?

50. Inspect the 2016 & 2017 Divvy data
======================================

```{r inspect-divvy-data}
head(stations)
summary(stations)
nrow(trips)
head(trips)
summary(trips)
```

> Instructor notes: Here are some questions to ask the students, time
> permitting:
> 
>   + Were more trips taken in 2016 or 2017? How many?
>   + Which columns were converted to factors?
>   + Do you notice any other oddities from the summary?
>

53. Adjusting the plot
======================

ggplot has many options for changing the look of the plot elements:

```{r plot-station-map-2}
g <- geom_point(shape = 21,fill = "limegreen",
                 color = "white",size = 3)
p <- ggplot_add(g,p)
print(p)
```

54. Use color to highlight the largest stations
===============================================

To do this, map the "dpcapacity" column to colour in the plot:

```{r plot-station-map-4}
a <- aes(x    = longitude,
         y    = latitude,
         fill = dpcapacity)
p <- ggplot(stations,a)
g <- geom_point(shape = 21,color = "white",
                size = 3)
p <- ggplot_add(g,p)
print(p)
```

55. Use color to highlight the largest stations
===============================================

The colour scale is not great, so let's improve it:

```{r plot-station-map-5}
g <- scale_fill_gradient2(low = "dodgerblue",
  mid = "darkblue",high = "red",midpoint = 25)
p <- ggplot_add(g,p)
print(p)
```

> Instructor notes: Where are the largest Divvy stations?

56. Scale points by number of departures
========================================

We need to add a new column to the "stations" data frame containing
the total number departures. It can be calculated from the "trips"
data frame:

```{r count-trips-per-station}
counts <- table(trips$from_station_name)
```

Because we used `read.divvy.data`, station counts should be the same
order as the stations. Let's verify this:

```{r check-station-trip-counts}
all(names(counts) == stations$name)
```

> Instructor notes: The number of departures at each station, should
> (roughly) correspond to population density.

57. Scale stations by the number of departures
==============================================

Add the trip counts to the "stations" data frame:

```{r add-counts-to-stations}
stations$departures <- as.vector(counts)
head(stations)
```

Now we can include the "departures" column in a plot:

```{r plot-station-map-6}
a <- aes(x    = longitude,
         y    = latitude,
 	     size = sqrt(departures))
p <- ggplot(stations,a)
```

Add points to your plot:

```{r plot-station-map-7}
# Add code here
```

> One possible answer:
>
>   g <- geom_point(shape = 21,fill = "white",
>                   color = "blue")
>   p <- ggplot_add(g,p)
>   print(p)
>

65. Save your results
=====================

Save your final results for safekeeping.

```{r save-session-3}
save.image("divvy_analysis.RData")
```

67. Why data analysis in R?
===========================

+ In R, a table or spreadsheet is stored in a "data frame". A data
  frame is an *object* that can be explored, manipulated and analyzed
  with code.

+ Developing your R code into a script will allow you to *automate*
  your data analyses.

68. Parting thoughts
====================

1. Always keep track of your analysis code in a file (ideally, in a
   script that can be run).

2. Use "R Markdown" to document your analyses.

3. Use packages---don’t reinvent the wheel.

5. Email help@rcc.uchicago.edu for advice on using R on the RCC
   cluster. See also
   [https://github.com/rcc-uchicago/R-large-scale][R-large-scale].

6. I recommend the **workflowr** package for streamlining your data
   analyses and making them more reproducible, and easier to share:
   [https://github.com/jdblischak/workflowr][workflowr]

7. Thank you!

[github-repo]: https://github.com/rcc-uchicago/R-intro-divvy
[divvy-data]: https://www.divvybikes.com/system-data
[rstudio-cloud]: https://rstudio.cloud
[ggplot2]: ggplot2.tidyverse.org
[R-large-scale]: https://github.com/rcc-uchicago/R-large-scale
[workflowr]: https://github.com/jdblischak/workflowr
